---
# User and its environment creation tasks.
# Target hosts: N/A
# Vars: usern
#

- name: Generate a new encrypted user password
  become: true
  when: inventory_hostname in groups['local']
  block:
  - name: Encrypt user password with openssl
    shell: echo {{ usern }} | openssl passwd -6 -stdin
    register: uspass

  - name: Deploy the user profile.d shell script template
    copy:
      src: "{{ playbook_dir }}/vars/user_creation_vars.yml"
      dest: "{{ playbook_dir }}/vars/{{ usern }}.yml"
      owner: ansible
      group: ansible
      mode: '0644'

  - name: Save the new encrypted password as a variable
    replace:
      path: "{{ playbook_dir }}/vars/{{ usern }}.yml"
      regexp: '^username_SHA512_pass: (.*)$'
      replace: "username_SHA512_pass: {{ uspass.stdout }}"

- name: Reload vars file
  become: true
  when: inventory_hostname != 'localhost'
  include_vars: "{{ playbook_dir }}/vars/{{ usern }}.yml"

- name: Create the group and the user with password
  become: true
  when: inventory_hostname != 'localhost'
  block:
  - name: Create user group
    group:
      name: "{{ usern }}"
      state: present

  - name: Create user with the same password
    user:
      name: "{{ usern }}"
      group: "{{ usern }}"
      password: "{{ username_SHA512_pass }}"
      generate_ssh_key: yes

- name: Deploy SSH keys relationships on every cluster node
  become: true
  become_user: "{{ usern }}"
  when: inventory_hostname != 'localhost'
  block:
  - name: Create user authorized_keys file and grant read permissions to both id_rsa.pub and authorized_keys files
    file:
      path: "{{ item }}"
      state: touch
      mode: '0644'
      modification_time: preserve
      access_time: preserve
    with_items:
      - "/home/{{ usern }}/.ssh/id_rsa.pub"
      - "/home/{{ usern }}/.ssh/authorized_keys"
      - "/home/{{ usern }}/.ssh/known_hosts"

  - name: Create the .ssh config file
    copy:
      dest: "/home/{{ usern }}/.ssh/config"
      content: StrictHostKeyChecking no
      owner: "{{ usern }}"
      group: "{{ usern }}"
      mode: '0644'

  - name: Include the user public key into its authorized_keys file
    ignore_errors: yes
    shell: |
      encr=$(awk '{print $2}' /home/{{ usern }}/.ssh/id_rsa.pub)
      grep ${encr} /home/{{ usern }}/.ssh/authorized_keys
      [[ $? -ne 0 ]] && cat /home/{{ usern }}/.ssh/id_rsa.pub >> /home/{{ usern }}/.ssh/authorized_keys

- name: Enable SSH login to remote users
  become: true
  when: inventory_hostname != 'localhost'
  shell: |
    grep AllowUsers /etc/ssh/sshd_config | grep "{{ usern }}"
    if [ $? -ne 0 ]
    then
      line=$(grep AllowUsers /etc/ssh/sshd_config 2>/dev/null)
      line=${line}" "{{ usern }}
      sed -i "s/AllowUsers.*$/${line}/" /etc/ssh/sshd_config
    fi

- name: Restart SSH service
  become: true
  when: inventory_hostname != 'localhost'
  service:
    name: sshd
    state: restarted

- name: Deploy the user profile.d shell script
  become: true
  when: inventory_hostname != 'localhost'
  block:
  - name: Deploy the user profile.d shell script template
    copy:
      src: generic_profile.sh
      dest: /etc/profile.d/{{ usern }}.sh
      owner: root
      group: root
      mode: '0644'

  - name: Substitute the username into the user profile.d shell script
    shell: |
      sed -i 's/__var__/{{ usern | upper }}/' /etc/profile.d/{{ usern }}.sh
      sed -i 's/__var__/{{ usern }}/' /etc/profile.d/{{ usern }}.sh
    args:
      warn: no

...
